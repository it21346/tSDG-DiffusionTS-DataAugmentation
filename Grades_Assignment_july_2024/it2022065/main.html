<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>  
        <title>Bookstore</title>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <div id="utilities">
            <div>
                <label class="title"> <b>Book Registry</b></label><br>
                <input type="text" id="book" placeholder="Book"/><br>
                <p id="bookError" class="errormessage"></p>
                <input type="text" id="author" placeholder="Author"/><br>
                <p id="authorError" class="errormessage"></p>
                <select id="genre">
                    <option value="0">Select genre...</option>
                    <option value="Science fiction">Science fiction</option>
                    <option value="Satire">Satire</option>
                    <option value="Drama">Drama</option>
                    <option value="Action and Adventure">Action and Adventure</option>
                    <option value="Romance">Romance</option>
                    <option value="Mystery">Mystery</option>
                    <option value="Horror">Horror</option>
                </select><br>
                <p id="selectError" class="errormessage"></p>
                <input type="text" id="price" placeholder="Price"/><br>
                <p id="priceError" class="errormessage"></p>
                <button type="submit" id="RegBook"> Register Book
                </button><br>
            </div>
            <div>
                <label class="title"> <b>Search Book</b></label><br>
                <input id="searchtext" type="text" placeholder="Search..">
                <button id="searchbar" type="submit"> Search </button>
            </div>
        </div>
        <div class="divisor"></div>
        <div id="BookPlaceholder">
        </div>


        <script>

            async function sendBook(title, author, genre, price){
                try{
                    const response = await fetch('http://localhost:3000/books',{
                        method:"POST",
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({"title": title, "author": author, "genre":genre, "price":price})
                    });
                    if(response.status == 200){
                        window.alert("Book Successfully Registered");
                    }
                }catch(err){
                    console.error(err.message);
                }
            }

            const postbook = document.getElementById("RegBook");
            postbook.addEventListener('click', function(){
                const title = document.getElementById("book").value;
                const author = document.getElementById("author").value;
                const genre = document.getElementById("genre").value;
                const price = document.getElementById("price").value;
                const titleerror = document.getElementById("bookError");
                const authorerror = document.getElementById("authorError");
                const genreerror = document.getElementById("selectError");
                const priceerror = document.getElementById("priceError");
                let check = true;
                if(title == null || title==""){
                    titleerror.innerText = "Provide a Book Title!";
                    check = false;
                }
                else titleerror.innerText = "";
                if(author == null || author==""){
                    authorerror.innerText = "Provide an Author!";
                    check = false;
                }
                else  authorerror.innerText = "";
                if (genre == 0){
                    genreerror.innerText = "Select a Genre!"
                    check = false;
                }
                else genreerror.innerText = ""
                if(!(!isNaN(parseFloat(price)) && isFinite(price)) || price.split('.')[1]>99){
                    priceerror.innerText = "Provide Price!(ex. '7', '7.2', '7.22')";
                    check = false;
                }
                else priceerror.innerText = "";              
                if(check) sendBook(title, author, genre, price);
            });
            


            function createBook(book){
                const div = document.createElement("div");
                div.id = "bookentry";
                for(i in book){
                    let p = document.createElement("p");
                    p.id = i;
                    let node = document.createTextNode(i+": "+book[i]);
                    p.appendChild(node);
                    div.appendChild(p);
                }  
                return div;    
            }
            async function searchBook(search){
                try{
                    const response = await fetch('http://localhost:3000/books/'+search,{
                        method:"GET",
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    //const text = await response.text();
                    const books = JSON.parse(await response.text());
                    const placeholder = document.getElementById("BookPlaceholder");
                    
                    while (placeholder.firstChild) {
                            placeholder.removeChild(placeholder.lastChild);
                    }

                    if(Object.keys(books).length === 0){
                        let node = document.createTextNode("No books found!");
                        node.is
                        placeholder.innerHTML="<b style= font-size:2em;>No books found!<b>";
                    }
                    else{
                        for (book in books){
                            placeholder.appendChild(createBook(books[book]));
                        }
                    }

                }catch(err){
                    console.error(err);
                }
                
            }
            
            const getbook = document.getElementById("searchbar");
            getbook.addEventListener('click', function(){
                const search = document.getElementById("searchtext").value;
                searchBook(search);
            });
            

        </script>
    </body>
</html>
