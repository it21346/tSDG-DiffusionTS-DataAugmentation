<!DOCTYPE html>
<html>
<head>
    <link href="css.css" rel="stylesheet">
</head>
<body>
<div id="mainDiv" class="container">
    <!-- ειδοποίηση για επιτυχή καταχώρηση βιβλίου -->
    <div id="snackbar">Book registered successfully!</div> 
    <div id="uselessDiv" class="blackbox invisible"></div>
    <div id="myDIV" class="blackbox mainAdjust">
        <div class="heading">
            <h1>Welcome!</h1>
        </div><br>
        <button id="buttonRegister" class="button" style="vertical-align:middle"><span>Register a book</span></button>
        <button id="buttonSearch" class="button" style="vertical-align:middle"><span>Search for a book</span></button>
    </div>
    <div class="miniContainer">
        <div id="regDiv" class="blackbox adjust appear inner">
            <div class="whitebox">
                <h1>Register book:</h1>
                <h3>ID:</h3>
                <input type="text" id="id" placeholder="Enter the book's ID"><br> 
                <h3 >Title:</h3>
                <input type="text" id="title" placeholder="Enter the book's title"><br> 
                <h3 >Author:</h3>
                <input type="text" id="author" placeholder="Enter the book's author"><br>
                <h3 >Price:</h3>
                <input type="text" id="price" placeholder="Enter the book's price"><br>
                <h3 >Pick a genre:</h3>
                <select id="genre">
                    <!-- https://stackoverflow.com/questions/3518002/how-can-i-set-the-default-value-for-an-html-select-element -->
                    <option value="default" selected disabled hidden>---</option>
                    <option value="Science fiction">Science fiction</option>
                    <option value="Satire">Satire</option>
                    <option value="Drama">Drama </option>
                    <option value="Action and Adventure">Action and Adventure </option>
                    <option value="Romance">Romance </option>
                    <option value="Mystery">Mystery </option>
                    <option value="Horror">Horror </option>
            </select>
            </div>
            <br><br>
            <button id="registerButton" class="button2" style="vertical-align:middle"><span>Register book</span></button><br><br>
        </div>
        <div id="searchDiv" class="blackbox adjust appear inner">
            <div class="whitebox">
                <h1>Search for a book:</h1>
                <input type="text" id="searchInput" placeholder="Enter the title or a keyword"><br>
            </div>
            <button id="searchButton" class="button2" style="vertical-align:middle"><span>OK</span></button><br>
            <div class="whitebox">
                <h3 >Results:</h3>
                <select id="resultSelect">
                    <option id="defaultOption" selected disabled hidden>---</option>
                </select>
            </div>
            <div class="whitebox">
                <div id="resultDiv" class="resultDivText">
                    <div id="noRes"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<script>
    //functions για να παίξουν τα animations των divs
    function mainPlayFunction() {
        document.getElementById("myDIV").style.animationPlayState = "running";
    }

    function regPlayFunction() {
        document.getElementById("regDiv").style.animationPlayState = "running";
    }

    function searchPlayFunction() {
        document.getElementById("searchDiv").style.animationPlayState = "running";
    }


    document.getElementById('buttonRegister').addEventListener('click', function(){
        //εμφανίζεται το div 'regDiv' και εξαφανίζεται το 'searchDiv'
        const elem = document.getElementById('regDiv');
        const elem_opp = document.getElementById('searchDiv');

        if(elem.classList.contains("hidden")){
            replaceHiddenClass(elem);
        }
        if(elem_opp.classList.contains("appear")){
            replaceAppearClass(elem_opp);
            searchPlayFunction();
        }
        mainPlayFunction();
        regPlayFunction();
    });

    document.getElementById('buttonSearch').addEventListener('click', function(){
        //εμφανίζεται το div 'searchDiv' και εξαφανίζεται το 'regDiv'
        const elem = document.getElementById('searchDiv');
        const elem_opp = document.getElementById('regDiv');

        if(elem.classList.contains("hidden")){
            replaceHiddenClass(elem);
        }
        if(elem_opp.classList.contains("appear")){
            replaceAppearClass(elem_opp);
            regPlayFunction();
        }
        mainPlayFunction();
        searchPlayFunction();
    });

    //functions που αντικαθιστούν το αντίστοιχο class από το element
    function replaceAppearClass(elem){
        if (elem.classList.contains("appear")){
            elem.classList.replace("appear","hidden");
        } else {
            return;
        }
    }

    function replaceHiddenClass(elem){
        if (elem.classList.contains("hidden")){
            elem.classList.replace("hidden","appear");
        } else {
            return;
        }
    }

    //προσθήκη βιβλίου
    document.getElementById('registerButton').addEventListener('click',async function(e){

        const url = window.origin+'/books/';
        const bookID = document.getElementById('id').value;
        const bookTitle = document.getElementById('title').value;
        const bookAuthor = document.getElementById('author').value;
        const bookPrice = document.getElementById('price').value;
        const bookGenre = document.getElementById('genre').value;

        const newBook = {
            "id": bookID,
            "title": bookTitle,
            "author": bookAuthor,
            "price": bookPrice,
            "genre": bookGenre
        };

        if (Math.sign(bookPrice)!=1){
            userInput = prompt('Please enter a valid price');
            while(userInput<=0){
                userInput=prompt('Please enter a valid price (positive number)');
            }
            document.getElementById('price').value=userInput;
            bookPrice = document.getElementById('price').value;
            newBook.price=bookPrice;
        }

        if (Math.sign(bookID)!=1){
            userInput = prompt('Please enter a valid ID');
            while(userInput<=0){
                userInput=prompt('Please enter a valid price (positive integer)');
            }
            document.getElementById('id').value=userInput;
            bookID = document.getElementById('id').value;
            newBook.id=bookID;
        }

        try {

            const response = await fetch(url,{
                //το δοκίμασα με post όπως λέει η εκφώνηση αλλά δεν δουλεύει,οπότε το έκανα όπως δείξατε στα εργαστήρια
                method:"PUT", 
                headers:{
                    "Content-Type":"application/json"
                },
                body:JSON.stringify(newBook)
            });
            console.log(await response.json());
            var x = document.getElementById("snackbar");
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        } catch(err) {
            console.error(err);
        }
    });

    //αναζήτηση βιβλίου με keyword
    document.getElementById('searchButton').addEventListener('click', async function(e){

                const url = window.origin+'/books/';
                const keyword = document.getElementById('searchInput').value;
                const selectElem = document.getElementById('resultSelect');
                const noRes = document.getElementById('noRes');
                removeAllChildNodes(selectElem);
                const resDiv = document.getElementById('resultDiv');
                removeAllChildNodes(resDiv);
                const defaultOption = document.createElement('option');
                try {
                    const result = await fetch(url+keyword);
                    const books = await result.json();
                    //άμα δεν βρεθεί βιβλίο που να περιέχει το keyword , εκτυπώνεται το παρακάτω μήνυμα
                    if(books.length===0){
                        const textNode=document.createTextNode('No results found.');
                        resDiv.appendChild(textNode);
                    }
                    selectElem.appendChild(defaultOption);
                    defaultOption.hidden = true;
                    defaultOption.disabled = true;
                    for (book of books){
                        title = book.title;
                        const optionElem = document.createElement('option');
                        optionElem.value = title;
                        const textNodeText = document.createTextNode(title);
                        optionElem.appendChild(textNodeText);
                        selectElem.appendChild(optionElem);
                    } 
                } catch(err){
                    console.error(err);
                }
            });

            //μόλις αλλάξει το επιλεγμένο option, εκτυπώνονται τα στοιχεία του καινούργιου επιλεγμένου option
            document.getElementById('resultSelect').addEventListener('change',async function(e){
                    const url = window.origin+'/books/';
                    const keyword = document.getElementById('searchInput').value;
                    const selectElement = document.getElementById('resultSelect');
                    const selectedOption = selectElement.options[selectElement.selectedIndex].value;
                    const noRes = document.getElementById('noRes');
                    const resDiv = document.getElementById('resultDiv');
                    removeAllChildNodes(resDiv);
                        try {
                            appendChildNodes(resDiv);
                            const result = await fetch(url+keyword);
                            const books = await result.json();
                            for(book of books){
                                if(book.title===selectedOption){

                                    const idDiv = document.getElementById('idDiv');
                                    const titleDiv= document.getElementById('titleDiv');
                                    const authorDiv = document.getElementById('authorDiv');
                                    const priceDiv = document.getElementById('priceDiv');
                                    const genreDiv = document.getElementById('genreDiv');

                                    const idNodeText = document.createTextNode('ID: '+book.id);
                                    const titleNodeText = document.createTextNode('Title: '+book.title);
                                    const authorNodeText = document.createTextNode('Author: '+book.author);
                                    const priceNodeText = document.createTextNode('Price: '+book.price+'€');
                                    const genreNodeText = document.createTextNode('Genre: '+book.genre);

                                    idDiv.appendChild(idNodeText);
                                    
                                    titleDiv.appendChild(titleNodeText);
                                    
                                    authorDiv.appendChild(authorNodeText);
                                    
                                    priceDiv.appendChild(priceNodeText);
                                    
                                    genreDiv.appendChild(genreNodeText);
                                }
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    });

        
    // https://www.javascripttutorial.net/dom/manipulating/remove-all-child-nodes/
    function removeAllChildNodes(parent) {
        while (parent.firstChild) {
            parent.removeChild(parent.firstChild);
        }
    }

    function appendChildNodes(parent){
        const idDiv = document.createElement('div');
        idDiv.id = 'idDiv';
        const titleDiv = document.createElement('div');
        titleDiv.id = 'titleDiv';
        const authorDiv = document.createElement('div');
        authorDiv.id = 'authorDiv';
        const priceDiv = document.createElement('div');
        priceDiv.id = 'priceDiv';
        const genreDiv = document.createElement('div');
        genreDiv.id = 'genreDiv';

        parent.appendChild(idDiv);
        parent.appendChild(titleDiv);
        parent.appendChild(authorDiv);
        parent.appendChild(priceDiv);
        parent.appendChild(genreDiv);
    }

    //doubleclick για να καθαρίσει το πεδίο
    document.getElementById('id').addEventListener('dblclick',function(err){
        const idInput = document.getElementById('id');
        idInput.value='';
    });
    document.getElementById('title').addEventListener('dblclick',function(err){
        const titleInput = document.getElementById('title');
        titleInput.value='';
    });
    document.getElementById('author').addEventListener('dblclick',function(err){
        const authorInput = document.getElementById('author');
        authorInput.value='';
    });
    document.getElementById('price').addEventListener('dblclick',function(err){
        const priceInput = document.getElementById('price');
        priceInput.value='';
    });

</script>

</html>

